# Secrets

### Kubernetess Secrets
1. `kubectl create secret generic secret --from-literal=secret=secret`
2. `kubectl get secrets`
```
NAME                                   TYPE                 DATA   AGE
secret                                 Opaque               1      31s
```
3. `kubectl describe secret secret`
```
Name:         secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
secret:  6 bytes
```
4. `kubectl get secrets secret -o yaml`
```
apiVersion: v1
data:
  secret: c2VjcmV0
kind: Secret
metadata:
  creationTimestamp: "2024-04-13T20:30:33Z"
  name: secret
  namespace: default
  resourceVersion: "5401"
  uid: d9781b45-a04b-4449-a592-7d4631c937e4
type: Opaque
```
5. `kubectl get secret secret -o jsonpath='{.data.password}' | base64 --decode
adari_ka@MacBookPro k8s % kubectl get secret secret -o jsonpath='{.data.secret}' | base64 --decode`
```
secret%
```

### Helm Secrets

1. `helm plugin install https://github.com/zendesk/helm-secrets` + `brew install gnu-getopt`
2. `helm secrets install python-app ./python-app -n default -f secrets.yml` - install python-app
3. `kubectl get po`
```
NAME                          READY   STATUS    RESTARTS        AGE
python-app-566d87f497-hgdtb   1/1     Running   1 (2m17s ago)   21m
```
4. `kubectl get svc,deployments,secrets`
```
NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP          6d2h
service/python-app   NodePort    10.103.237.193   <none>        8000:32668/TCP   2m40s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/python-app   1/1     1            1           2m40s

NAME                                      TYPE                 DATA   AGE
secret/secret                             Opaque               1      133m
secret/sh.helm.release.v1.python-app.v1   helm.sh/release.v1   1      2m52s
```
5. ` kubectl exec python-app-566d87f497-hgdtb -- env | grep SECRET`
```
SECRET=secret
```

## Vault Secret Managment System
1. Set a Secret in Vault `kubectl exec -it vault-0 -- /bin/sh`
   - `vault secrets enable -path=internal kv-v2`
        ```
        Success! Enabled the kv-v2 secrets engine at: internal/
        ```
   - `vault kv put internal/vs/config secret="vault-secret"`

        ```
        ===== Secret Path =====
        internal/data/vs/config

        ======= Metadata =======
        Key                Value
        ---                -----
        created_time       2024-04-14T20:06:46.054630979Z
        custom_metadata    <nil>
        deletion_time      n/a
        destroyed          false
        version            1
        ```
   - `vault kv get internal/vs/config`
        ```
        ===== Secret Path =====
        internal/data/vs/config

        ======= Metadata =======
        Key                Value
        ---                -----
        created_time       2024-04-14T20:06:46.054630979Z
        custom_metadata    <nil>
        deletion_time      n/a
        destroyed          false
        version            1

        ===== Data =====
        Key       Value
        ---       -----
        secret    vault-secret
        ```
2. Configure Kubernetes Auth (still completed in vault bash)
   - `vault auth enable kubernetes`
        ```
        Success! Enabled kubernetes auth method at: kubernetes/
        ```
   - `vault write auth/kubernetes/config \
      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"`
        ```
        Success! Data written to: auth/kubernetes/config
        ```
   -  create upload policy
        ```
        / $ vault policy write internal-app - <<EOF
        > path "internal/data/vs/config" {
        >    capabilities = ["read"]
        > }
        > EOF
        Success! Uploaded policy: internal-app
        ```
   - `vault write auth/kubernetes/role/internal-app bound_service_account_names=internal-app bound_service_account_namespaces=default policies=internal-app ttl=24h`
    ```
    Success! Data written to: auth/kubernetes/role/internal-app
    ```
3. `kubectl create sa internal-app`
    ```
    serviceaccount/internal-app created
    ```

4. `kubectl get sa -n default`
    ```
    NAME                   SECRETS   AGE
    default                0         6d23h
    internal-app           0         16s
    vault                  0         21h
    vault-agent-injector   0         21h
    ```

5. `kubectl get pods`
    ```
    NAME                                   READY   STATUS    RESTARTS      AGE
    python-app-556488479f-wrpv2            2/2     Running   0             4m42s
    vault-0                                1/1     Running   2 (58m ago)   21h
    vault-agent-injector-dbfc5cd77-6gzkk   1/1     Running   2 (58m ago)   21h
    ```
6. `kubectl exec -it python-app-556488479f-wrpv2 -- bash`
    ```
    app@python-app-556488479f-wrpv2:/$ cat vault/secrets/vs-config.txt 
    data: map[secret:vault-secret]
    metadata: map[created_time:2024-04-14T20:06:46.054630979Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
    ```
7. `df -h`
   ```
    Filesystem      Size  Used Avail Use% Mounted on
    overlay          79G   62G   14G  83% /
    tmpfs            64M     0   64M   0% /dev
    tmpfs           7.7G  4.0K  7.7G   1% /vault/secrets
    /dev/vda1        79G   62G   14G  83% /etc/hosts
    shm              64M     0   64M   0% /dev/shm
    tmpfs           7.7G   12K  7.7G   1% /run/secrets/kubernetes.io/serviceaccount
    tmpfs           3.9G     0  3.9G   0% /proc/acpi
    tmpfs           3.9G     0  3.9G   0% /sys/firmware
   ```